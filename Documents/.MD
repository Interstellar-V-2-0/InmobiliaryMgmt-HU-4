 Implementación del Servicio de Envío de Correos (EmailService)

Este documento explica todo lo que se creó, qué librerías se utilizaron, dónde se colocó cada parte en la arquitectura DDD, y qué debes configurar para que el envío de correos funcione correctamente en tu proyecto inmobiliario hecho en C#.

 1. Arquitectura y Componentes Creados

En la arquitectura DDD (Domain–Application–Infrastructure) se creó la siguiente funcionalidad:

1.1. Application Layer

Se creó la interfaz:

public interface IEmailService
{
Task SendEmailAsync(string to, string subject, string body);
}


Esta interfaz define el contrato que permite a cualquier parte del sistema enviar correos electrónicos.

1.2. Infrastructure Layer

Se creó la clase EmailService, que implementa IEmailService usando MailKit y MimeKit.

Este servicio:

Construye el mensaje (remitente, destinatario, asunto, cuerpo).

Crea conexión segura al servidor SMTP de Gmail.

Autentica con una Contraseña de Aplicación.

Envía el correo mediante smtp.SendAsync.

1.3. Inyección de Dependencias

En Program.cs se registraron los servicios necesarios:

builder.Services.AddScoped<IEmailService, EmailService>();
builder.Services.AddScoped<IContactRequestService, ContactRequestService>();
builder.Services.AddScoped<IContactRequestRepository, ContactRequestRepository>();
builder.Services.AddScoped<IPropertyRepository, PropertyRepository>();


Esto permite usar EmailService desde controladores y servicios sin acoplar directamente la lógica SMTP.

 2. Paquetes Utilizados

En la capa Infrastructure, se instalaron:

MailKit

Cliente moderno para SMTP (envío de correos).

SmtpClient

SecureSocketOptions

MimeKit

Para construir los mensajes de correo.

MimeMessage

TextPart

MailboxAddress

Instalación (en la carpeta del proyecto Infrastructure):

dotnet add package MailKit
dotnet add package MimeKit

 3. Código Implementado del Servicio (EmailService)
using InmobiliaryMgmt.Application.Interfaces;
using MailKit.Net.Smtp;
using MailKit.Security;
using MimeKit;
using MimeKit.Text;

namespace InmobiliaryMgmt.Infrastructure.Email;

public class EmailService : IEmailService
{
public async Task SendEmailAsync(string to, string subject, string body)
{
var email = new MimeMessage();
email.From.Add(MailboxAddress.Parse("correo@gmail.com"));
email.To.Add(MailboxAddress.Parse(to));
email.Subject = subject;

        email.Body = new TextPart(TextFormat.Plain)
        {
            Text = body
        };

        using var smtp = new SmtpClient();
        await smtp.ConnectAsync("smtp.gmail.com", 587, SecureSocketOptions.StartTls);

        await smtp.AuthenticateAsync("tu-correo@gmail.com", "tu-contraseña-de-aplicación");

        await smtp.SendAsync(email);
        await smtp.DisconnectAsync(true);
    }
}

 4. Configuración Obligatoria para que Gmail Permita Enviar Correos

Gmail NO permite usar la contraseña normal para enviar correo desde aplicaciones externas como MailKit.

Debes hacer lo siguiente:
✔ 1. Activar la Verificación en Dos Pasos

Ir a:

Google → Administrar cuenta → Seguridad → Verificación en dos pasos

✔ 2. Crear una Contraseña de Aplicación

Ir a Seguridad → Contraseñas de aplicaciones

Elegir:

Aplicación: "Correo"

Dispositivo: "Windows Computer"

Google generará una contraseña de 16 dígitos, por ejemplo:

abcd efgh ijkl mnop


Esa es la que debes usar como "tu-contraseña-de-aplicación".

️ 5. Mantener las Credenciales Seguras (Recomendado)

No poner la contraseña directamente en el código.

Crear variables de entorno:
setx SMTP_EMAIL "miempresa@gmail.com"
setx SMTP_PASSWORD "abcd efgh ijkl mnop"

Leerlas desde C#:
var emailUser = Environment.GetEnvironmentVariable("SMTP_EMAIL");
var emailPassword = Environment.GetEnvironmentVariable("SMTP_PASSWORD");

 6. Flujo que Se Implementó en el Sistema

El usuario llena un formulario de contacto (mensaje + propiedad).

Se guarda un ContactRequest.

El servicio obtiene el correo del propietario/agencia.

Se llama a:

await _emailService.SendEmailAsync(owner.Email, subject, message);


Gmail envía el correo a través de MailKit.

 7. Resumen General
Elemento	Descripción
IEmailService	Contrato para enviar correos
EmailService	Implementación SMTP con MailKit
MailKit + MimeKit	Librerías utilizadas
Program.cs	Se registró la DI
Gmail	Requiere contraseña de aplicación
Variables de entorno	Recomendado para seguridad